<!DOCTYPE html>
<html>
<head>
        <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'>
        <meta name='mobile-web-app-capable' content='yes'>
        <meta name='apple-mobile-web-app-capable' content='yes'>
        <meta name='apple-mobile-web-app-status-bar-style' content='black'>
        <meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui'>
        <meta name="theme-color" content="#0f9d58">

        <title>Drone Controller</title>

        <!-- Material Design fonts -->
        <link async rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
        <!--<link async href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">-->

        <!-- Bootstrap -->
        <link async href="css/bootstrap.min.css" rel="stylesheet">

        <!-- Bootstrap Material Design -->
        <link async href="css/material.css" rel="stylesheet">
        <link async href="css/ripples.min.css" rel="stylesheet">

        <!-- Font Awesome -->
        <link async rel="stylesheet" href="css/fontawesome/css/font-awesome.min.css">

        <!-- JavaScript/jQuery Dependencies -->
        <script src="js/jquery.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/material.min.js"></script>
        <script src="js/materials.min.js"></script>
		<style>
			button.btn.btn-fab.actionFab {
				border-radius: 50%;
				font-size: 15vmin;
				height: 25vmin;
				margin: auto;
				min-width: 56px;
				width: 25vmin;
				padding: 0;
				overflow: hidden;
				-webkit-box-shadow: 0 1px 1.5px 0 rgba(0, 0, 0, 0.12), 0 1px 1px 0 rgba(0, 0, 0, 0.24);
				box-shadow: 0 1px 1.5px 0 rgba(0, 0, 0, 0.12), 0 1px 1px 0 rgba(0, 0, 0, 0.24);
				position: relative;
				line-height: normal;
				background-color: white;
			}
			.status {
				font-size: 5vmin;
			}
			.gap {
				padding-bottom: 15px;
			}
			body {
				font-size: 2vw;
			}
			h1 {
				font-size: 5vh;
			}
			div.container-fluid {
				margin:  3vmin;
			}
			.true {
				color: green;
			}
			.tralse {
				color: yellow;
			}
			.false {
				color: red;
			}
			.droneData > div {
				font-size: 2.0vw;
			}
			.noMargin {
				margin: 0 !important;
			}
			.noPad {
				padding: 0 !important;
			}
			.droneLog {
				font-size:  2vw !important;
			}
			.modal-lg-all {
				min-width: 675px;
    				width: 60vw;
			}
		</style>
</head>
<body>
<h1 class="text-center">Dancing Drones Control Board</h1>
<script src="/socket.io/socket.io.js"></script>
<div class="container-fluid">
	<div class="text-center gap row preFlight">
                <div class="col-md-6 col-sm-12 text-center">
                        <button id="loadJacq" type="button" class="btn btn-fab actionFab"><span class="fa fa-upload" aria-hidden="true"></span></button>
			<br>
			<div class="container-fluid">
                        	<div class="col-sm-7">
					<select id="fileNameList" class="form-control">
						<option>Select a JOCS File</option>
						<option>jumpManJumpManJumpMan.jocs</option>
						<option>exesAndOhs.jocs</option>
						<option>operationPhilia.jocs</option>
					</select>
				</div>
				<div class="col-sm-5">
					<select id="queueList" class="form-control">
  		                              	<option>Start</option>
                		                <option>1</option>
                                		<option>2</option>
                                		<option>3</option>
                        		</select>
				</div>
			</div>
                </div>
                <div class="col-md-3 col-sm-6 text-center">
                        <button id="positionMap" type="button" class="btn btn-fab actionFab" data-toggle="modal" data-target="#droneMapModal"><span class="fa fa-bullseye" aria-hidden="true"></span></button>
                        <br><br>
                </div>
                <div class="col-md-3 col-sm-6 text-center">
                        <button id="takeOff" type="button" class="btn btn-fab actionFab"><span class="fa fa-rocket" aria-hidden="true"></span></button>
                        <br><br>
                </div><!--
                <div class="col-md-3 col-sm-6 text-center">
                        <button id="killDrones" type="button" class="btn btn-fab actionFab"><i class="fa fa-bomb" aria-hidden="true"></i></button>
                        <br><br>
                </div>-->
        </div>
	<div class="text-center gap row flightReady">
		<div class="col-md-3 col-sm-6 text-center">
			<button id="playDrones" type="button" class="btn btn-fab actionFab"><span class="glyphicon glyphicon-play" aria-hidden="true"></span></button>
			<br><br>
		</div>
		<div class="col-md-3 col-sm-6 text-center">
			<button id="pauseDrones" type="button" class="btn btn-fab actionFab"><span class="glyphicon glyphicon-pause" aria-hidden="true"></span></button>
			<br><br>
		</div>
		<div class="col-md-3 col-sm-6 text-center">
			<button id="stopDrones" type="button" class="btn btn-fab actionFab"><span class="glyphicon glyphicon-stop" aria-hidden="true"></span></button>
			<br><br>
		</div>
		<div class="col-md-3 col-sm-6 text-center">
			<button id="killDrones" type="button" class="btn btn-fab actionFab"><i class="fa fa-bomb" aria-hidden="true"></i></button>
			<br><br>
		</div>
	</div>
	<div class="row">
		<div class="col-sm-3 text-center">
			MoCap:&nbsp;&nbsp;<i class="fa fa-binoculars moCapStatus" aria-hidden="true"></i>
		</div>
		<div class="col-sm-3 text-center">
                        Ready:&nbsp;&nbsp;<i class="fa fa-circle readyStatus" aria-hidden="true"></i>
                </div>
		<div class="col-sm-3 text-center">
			Playing:&nbsp;&nbsp;<i class="fa fa-circle playStatus" aria-hidden="true"></i>
		</div>
		<div class="col-sm-3 text-center">
			Run Time:&nbsp;&nbsp;<span id="runTime">0</span> secs
		</div>
	</div>
	<br>
	<!--
	<div class="row droneData">
		<div class="col-sm-1">
			<i class="fa fa-plane" aria-hidden="true"></i> <span class="droneID">1</span>
		</div>
		<div class="col-sm-3 text-center">
			Tracking:&nbsp;&nbsp;<i class="fa fa-circle tracking" aria-hidden="true"></i>
		</div>
		<div class="col-sm-3 text-center">
			Connected:&nbsp;&nbsp;<i class="fa fa-circle connected" aria-hidden="true"></i>
		</div>
		<div class="col-sm-3 text-center">
			Armed:&nbsp;&nbsp;<i class="fa fa-circle armed" aria-hidden="true"></i>
		</div>
		<div class="col-sm-2 text-center">
			<button class="btn btn-sm noMargin droneLog"><i class="fa fa-terminal" aria-hidden="true"></i>&nbsp;&nbsp;Log</button>
		</div>
	</div>-->
	<div id="droneTable">
	</div>
</div>
<div class="modal fade" id="droneMapModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog modal-lg-all" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Drone Starting Map</h4>
      </div>
      <div class="modal-body text-center">
        <canvas id="droneMap" width="600" height="400"></canvas>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<template id="droneRow">
	<div class="row droneData">
		<div class="col-sm-1 col-md-1 noPad">
			<i class="fa fa-plane" aria-hidden="true"></i> <span class="droneID"></span>
		</div>
		<div class="col-md-1 visible-md visible-lg text-center">
			<i class="fa fa-exchange" aria-hidden="true"></i>
		</div>
		<div class="col-sm-3 col-md-2 visible-md visible-lg text-center">
			Battery:&nbsp;&nbsp;<i class="battery-level fa" aria-hidden="true"></i>
		</div>
		<div class="col-sm-3 col-md-2 text-center">
			Tracking:&nbsp;&nbsp;<i class="fa fa-circle tracking" aria-hidden="true"></i>
		</div>
		<div class="col-sm-3 col-md-2 text-center">
			Connected:&nbsp;&nbsp;<i class="fa fa-circle connected" aria-hidden="true"></i>
		</div>
		<div class="col-sm-3 col-md-2 text-center">
			Armed:&nbsp;&nbsp;<i class="fa fa-circle armed" aria-hidden="true"></i>
		</div>
		<div class="col-sm-2 col-md-2 text-center">
			<button class="btn btn-sm noMargin droneLog"><i class="fa fa-terminal" aria-hidden="true"></i>&nbsp;&nbsp;Log</button>
		</div>
	</div>
</template>
<script>
var socket = io();

socket.emit("msg", JSON.stringify({type: 'list'}));

$(".flightReady").hide();
$.material.init();

var canvasWidth = 600;
var canvasHeight = 400;

var c_canvas = document.getElementById("droneMap");
var context = c_canvas.getContext("2d");

gridSetup();

// Test for Colors - Remove for Prod
$(".moCapStatus").addClass("true");
setFalse($(".playStatus"));
setFalse($(".tracking"));
setFalse($(".connected"));
setFalse($(".armed"));

// Event Listeners

$("#takeOff").click(function() {
	socket.emit('msg', JSON.stringify({type: 'prepare'}));
	swapControlPanels();
});

$("#playDrones").click(function () {
	setTrue($(".playStatus"));
	armDrones();
	trackDrones();
	connectToDrones();
	socket.emit('msg', JSON.stringify({type: 'play'}));
});

$("#pauseDrones").click(function () {
	setTralse($(".playStatus"));
	socket.emit('msg', {type: 'pause'});
});


$("#stopDrones").click(function () {
	socket.emit('msg', JSON.stringify({type: 'land'}));
	//setFalse($(".playStatus"));
	//disarm();
	swapControlPanels();
});


$("#killDrones").click(function () {
	socket.emit('msg', JSON.stringify({type: 'kill', enabled: true}));
	//setFalse($(".playStatus"));
	//disarm();
});

// This should receive data a few times a second
socket.on('msg', function(data) {
	data = JSON.parse(data);
	if(data.type == "status") {
		//$("#droneTable").html("");
		$('#runTime').text(Math.round(data.time*100)/100);
		setValue($('.playStatus'), data.global.playing);
		setValue($(".readyStatus"), data.global.ready);
		$.each(data.vehicles, function (index, drone) {
			if($("#drone" + drone.id).length == 0) {
				var droneRow = $($("#droneRow").html()); 
				droneRow.attr("id", "drone" + drone.id);
				droneRow.find(".droneID").html(drone.id);
				var batteryLevel = Math.floor((parseFloat(drone.battery.percent) * 100));
				var batteryIndicator = Math.floor(batteryLevel/25);
				//console.log(batteryLevel + " " + batteryIndicator);
				setValue(droneRow.find(".armed"), drone.armed);
				setValue(droneRow.find(".connected") , drone.connected);
				setValue(droneRow.find(".tracking") , drone.tracking);
				droneRow.find(".battery-level").addClass("fa-battery-" + batteryIndicator);
				$("#droneTable").append(droneRow);
				//console.log("Row Appended");
			} else {
				var droneRow = $("#drone" + drone.id);
				var batteryLevel = Math.floor((parseFloat(drone.battery.percentage) * 100));
				var batteryIndicator = Math.floor(batteryLevel/25);
				setValue(droneRow.find(".armed"), drone.armed);
				setValue(droneRow.find(".connected") , drone.connected);
				setValue(droneRow.find(".tracking") , drone.tracking);
				droneRow.find(".battery-level").addClass("fa-battery-" + batteryIndicator);
				//console.log("Row ammended");
			}
		});
	} else if (data.type == "list_reply") {
		console.log("This has been heard.");
		var stringOfOptions = "";
		$.each(data.files, function(index, value) {
			stringOfOptions += "<option>" + value + "</option>";
		}); 
		$("#fileNameList").html(stringOfOptions);
	} else {
		console.log("Unknown message type - " + data.type);
	}
});

// Repeatable Functions

function swapControlPanels() {
	$(".preFlight").slideToggle();
        $(".flightReady").slideToggle();
}

function armDrones() {
	setTrue($(".armed"));
}
function trackDrones() {
	setTrue($(".tracking"));
}
function connectToDrones() {
	setTrue($(".connected"));
}

function disarm() {
	setFalse($(".armed"));
}

function setValue(item, value) {
	if(value) {
		setTrue(item);
	} else {
		setFalse(item);
	}
}

function setTrue(item) {
	item.removeClass("false tralse").addClass("true");
}

function setTralse(item) {
	item.removeClass("false true").addClass("tralse");
}

function setFalse(item) {
	item.removeClass("true tralse").addClass("false");	
}

function gridSetup() {
	for (var x = 0.5; x < canvasWidth; x += 10) {
		context.moveTo(x, 0);
		context.lineTo(x, canvasHeight);
	}

	for (var y = 0.5; y < canvasHeight; y += 10) {
  		context.moveTo(0, y);
  		context.lineTo(canvasWidth, y);
	}

	context.strokeStyle = "#eee";
	context.stroke();
	
	var halfWidth = canvasWidth/2;
	var halfHeight = canvasHeight/2;
	
	context.beginPath();
	context.moveTo(halfWidth, 0)
	context.lineTo(halfWidth, canvasHeight);

	context.moveTo(0, halfHeight);
	context.lineTo(canvasWidth, halfHeight);

	context.strokeStyle = "#000";
	context.stroke();
}

function drawDrone(data) {


}

</script>
</body>
</html>
